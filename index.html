<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadSpark - All-in-One</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Arima+Madurai:wght@400;700;900&family=Corben:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* CSS Reset and Basic Setup */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        :root {
            /* Light Theme (Default) */
            --color-bg: #FFFFFF;
            --color-bg-alt: #EAEAEA;
            --color-surface: #FFFFFF;
            --color-text: #050404;
            --color-text-muted: #4A4A4A;
            --color-border: #DDDDDD;

            --color-primary: #EE5622;
            --color-primary-darker: #d94815;
            --color-secondary: #564787;
            --color-secondary-darker: #403368;
            --color-accent: #9F84BD;
            --color-accent-darker: #8a6fb8;

            --font-heading1: 'Arima Madurai', cursive;
            --font-heading2: 'Corben', cursive;
            --font-body: 'Open Sans', sans-serif;

            --shadow-sm: 0 2px 4px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.1);

            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 25px;
            
            /* Status Colors from Verifier/Log pages */
            --status-valid-color: green; 
            --status-invalid-color: red; 
            --status-risky-color: orange; 
            --status-unknown-color: dimgray;
        }

        .dark-theme {
            --color-bg: #121212;
            --color-bg-alt: #1E1E1E;
            --color-surface: #2C2C2C;
            --color-text: #EAEAEA;
            --color-text-muted: #A0A0A0;
            --color-border: #444444;

            --color-primary: #F0673E;
            --color-primary-darker: #EE5622;
            --color-secondary: #7A6AAF;
            --color-secondary-darker: #564787;
            --color-accent: #B6A0D5;
            --color-accent-darker: #9F84BD;

            --shadow-sm: 0 2px 4px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.35);

            /* Status Colors for Dark Theme */
            --status-valid-color: #4CAF50; 
            --status-invalid-color: #F44336; 
            --status-risky-color: #FF9800; 
            --status-unknown-color: #A0A0A0;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.7;
            color: var(--color-text);
            background-color: var(--color-bg);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            width: 90%;
            max-width: 1140px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        main {
            flex-grow: 1;
        }
        
        .page-content {
            display: none; /* Hidden by default, JS will show active page */
        }
        .page-content.active {
            display: block;
        }

        h1, h2, h3, h4, h5, h6 {
            line-height: 1.3;
            margin-bottom: 0.75em;
            font-weight: 700;
            color: var(--color-text);
        }

        h1 {
            font-family: var(--font-heading1);
            font-weight: 900;
            font-size: clamp(2.2rem, 4.5vw, 3.2rem);
        }

        h2 {
            font-family: var(--font-heading2);
            font-weight: 700;
            font-size: clamp(1.6rem, 3.5vw, 2.2rem);
            margin-bottom: 1.2em;
        }

        h3 { /* From Home Page, good general h3 */
            font-family: var(--font-heading2);
            font-weight: 700;
            font-size: clamp(1.1rem, 2.5vw, 1.4rem);
        }


        p {
            margin-bottom: 1.2em;
            color: var(--color-text-muted);
        }

        a {
            text-decoration: none;
            color: var(--color-primary);
            transition: color 0.3s ease;
        }
        a:hover { color: var(--color-primary-darker); }

        img { max-width: 100%; height: auto; display: block; }

        .btn {
            display: inline-block;
            padding: 0.8em 2em;
            border-radius: var(--border-radius-lg);
            font-weight: 700;
            text-decoration: none;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.3s ease, opacity 0.2s ease;
            cursor: pointer;
            border: none;
            font-size: 1rem;
            text-align: center;
            min-width: 80px; /* For copied! text */
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: #FFFFFF; 
        }
        .btn-primary:hover {
            background-color: var(--color-primary-darker);
            color: #FFFFFF; 
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: #FFFFFF; 
        }
        .btn-secondary:hover {
            background-color: var(--color-secondary-darker);
            color: #FFFFFF; 
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-accent { /* From Home/Finder page */
            background-color: var(--color-accent); 
            color: var(--color-text); 
        }
        .btn-accent:hover { 
            background-color: var(--color-accent-darker); 
            color: var(--color-text); 
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .dark-theme .btn-accent { 
            background-color: var(--color-accent); 
            color: #050404; /* Ensure contrast on dark theme */
        }
        .dark-theme .btn-accent:hover { 
            background-color: var(--color-accent-darker); 
            color: #050404; 
        }

        .btn-sm { /* From Dashboard/Log */
            padding: 0.5em 1.2em; font-size: 0.9rem; 
        }
        .btn-copy { /* From Finder/Verifier/Dashboard/Log */
            padding: 0.4em 0.8em;
            font-size: 0.85rem;
            margin-left: 0.5rem;
            border-radius: var(--border-radius-sm);
        }
        .btn-danger { /* From Log page */
            background-color: var(--status-invalid-color); 
            color: #fff;
        }
        .btn-danger:hover { 
            background-color: color-mix(in srgb, var(--status-invalid-color) 85%, black);
        }

        .btn.copied {
            background-color: var(--status-valid-color) !important; /* Use valid color for success */
            color: #fff !important;
            opacity: 0.8;
        }


        .text-center { text-align: center; }
        .section { padding: 60px 0; }
        .section-bg-alt { background-color: var(--color-bg-alt); }

        /* Navbar */
        .navbar {
            background-color: var(--color-surface);
            padding: 1rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            border-bottom: 1px solid var(--color-border);
        }
        .navbar-container { display: flex; justify-content: space-between; align-items: center; }
        .navbar-brand { font-family: var(--font-heading1); font-size: 1.8rem; font-weight: 700; color: var(--color-primary); }
        .navbar-nav { list-style: none; display: flex; gap: 1.5rem; align-items: center; }
        .navbar-nav a.nav-link { /* Changed selector for specificity */
             color: var(--color-text); font-weight: 600; padding-bottom: 0.3rem; position: relative; 
        }
        .navbar-nav a.nav-link::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px;
            background-color: var(--color-primary); transition: width 0.3s ease;
        }
        .navbar-nav a.nav-link:hover::after, .navbar-nav a.nav-link.active::after { width: 100%; }
        .navbar-nav a.nav-link:hover { color: var(--color-primary); text-decoration: none; }
        
        .theme-toggle-btn {
            background: none; border: none; font-size: 1.5rem; cursor: pointer;
            color: var(--color-text-muted); transition: color 0.3s ease;
            padding: 0.3em; line-height: 1;
        }
        .theme-toggle-btn:hover { color: var(--color-primary); }

        .navbar-toggler {
            display: none; font-size: 1.8rem; background: none; border: none;
            color: var(--color-text); cursor: pointer;
        }
        
        /* Page Headers (Common Style) */
        .page-header { /* Generic class for home-header, tool-page-header, dashboard-page-header */
            padding: 40px 0 20px;
            text-align: center;
            background-color: var(--color-bg-alt);
            border-bottom: 1px solid var(--color-border);
        }
        .page-header h1 { margin-bottom: 0.2em; }
        .page-header p { font-size: 1.1rem; color: var(--color-text-muted); margin-bottom: 0.5em; }
        
        /* Dashboard specific adjustments to page header */
        .dashboard-page-header { padding: 30px 0 10px; }
        .dashboard-page-header h1 { margin-bottom: 0.1em; }
        .dashboard-page-header p { font-size: 1rem; margin-bottom: 0.5em; }


        /* --- Home Page Specific Styles --- */
        .tool-access-section { padding: 50px 0; } /* from home */
        .tool-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2.5rem;
        }
        .tool-card {
            background-color: var(--color-surface);
            padding: 2rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
        }
        .tool-card h3 { margin-bottom: 1rem; color: var(--color-secondary); }
        .tool-card p { margin-bottom: 1.5rem; font-size: 0.95rem; flex-grow: 1; }
        .tool-card .btn { width: 100%; margin-top: auto; }
        
        .recent-activity-section { /* from home */
            background-color: var(--color-bg-alt);
            padding: 50px 0;
        }
        .activity-item { /* from home & dashboard */
            background-color: var(--color-surface);
            padding: 1rem 1.5rem; /* home */
            border-radius: var(--border-radius-sm);
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }
        /* Home specific activity item */
        #home-page-content .activity-item {
            border-left: 4px solid var(--color-accent);
        }
        #home-page-content .activity-item p { margin-bottom: 0.2rem; }
        #home-page-content .activity-item .timestamp { font-size: 0.85rem; color: var(--color-text-muted); }

        /* --- Finder/Verifier Page Specific Styles --- */
        .form-section { /* Common class for finder-form-section, verifier-form-section */
            background-color: var(--color-surface);
            padding: 2.5rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-md);
            max-width: 700px; 
            margin: 2rem auto 3rem auto;
            display: block; 
        }
        .form-group { margin-bottom: 1.5rem; }
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--color-text);
            text-align: left;
        }
        .form-input, .form-textarea { 
            width: 100%;
            padding: 0.9em 1.2em;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-family: var(--font-body);
            background-color: var(--color-bg); 
            color: var(--color-text);
            text-align: left;
        }
        .form-textarea { 
            min-height: 120px; /* finder */
            resize: vertical; 
        }
        #verifier-emails.form-textarea { min-height: 150px; } /* verifier specific */

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--color-primary) 20%, transparent);
        }
        .form-note {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin-top: 0.3rem;
            text-align: left;
        }
        .form-section .btn { /* finder-form-section .btn, verifier-form-section .btn */
            width: 100%;
            padding-top: 1em;
            padding-bottom: 1em;
            font-size: 1.1rem;
        }

        .results-section { /* Common for Finder, Verifier, Log */
            background-color: var(--color-surface);
            padding: 2rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-border);
        }
        .results-section h2 {
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .results-table { 
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .results-table th, .results-table td {
            text-align: left;
            padding: 0.85rem 0.75rem; 
            border-bottom: 1px solid var(--color-border);
            vertical-align: middle; /* verifier */
        }
        .results-table th {
            font-weight: 600;
            color: var(--color-text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        /* Finder specific table cell content */
        .results-table td .email-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .results-table td .email-list li {
            padding: 0.2rem 0;
            font-size: 0.95rem;
        }
        .results-table td .email-list .valid-email {
            color: var(--color-primary); 
            font-weight: 500;
        }
        /* Verifier/Log specific status cell */
        .results-table td.status-cell span {
            padding: 0.2em 0.5em; border-radius: var(--border-radius-sm); font-size: 0.9em; font-weight: 500;
            color: #fff; /* Default white text for status badges */
        }
        .status-valid { background-color: var(--status-valid-color); }
        .status-invalid { background-color: var(--status-invalid-color); }
        .status-risky { background-color: var(--status-risky-color); color: #000 !important; /* Black text for orange risky */ } 
        .dark-theme .status-risky { color: #000 !important; }
        .status-unknown { background-color: var(--status-unknown-color); }

        .results-placeholder {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--color-text-muted);
            border: 2px dashed var(--color-border);
            border-radius: var(--border-radius-sm);
        }

        /* --- Dashboard Specific Styles --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;}
        .stat-card { background-color: var(--color-surface); padding: 1.5rem; border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm); text-align: center; border-left: 5px solid; }
        .stat-card.primary { border-left-color: var(--color-primary); }
        .stat-card.secondary { border-left-color: var(--color-secondary); }
        .stat-card.accent { border-left-color: var(--color-accent); }
        .stat-card-value { font-size: 2.2rem; font-weight: 700; display: block; margin-bottom: 0.2rem; color: var(--color-text); }
        .stat-card-label { font-size: 0.9rem; color: var(--color-text-muted); }

        .dashboard-content-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .dashboard-panel { background-color: var(--color-surface); padding: 1.5rem; border-radius: var(--border-radius-md); box-shadow: var(--shadow-sm); }
        .dashboard-panel h3 { font-size: 1.3rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--color-border); display:flex; justify-content: space-between; align-items:center;}
        
        /* Dashboard activity list (different from home) */
        #dashboard-page-content .activity-list { list-style: none; padding: 0; }
        #dashboard-page-content .activity-item { padding: 0.75rem 0; border-bottom: 1px dashed var(--color-border); display: flex; justify-content: space-between; align-items: center;}
        #dashboard-page-content .activity-item:last-child { border-bottom: none; }
        #dashboard-page-content .activity-item p { margin-bottom: 0; font-size: 0.95rem; }
        #dashboard-page-content .activity-item .timestamp { font-size: 0.8rem; color: var(--color-text-muted); white-space: nowrap; margin-left: 1rem; }

        .chart-placeholder { background-color: var(--color-bg-alt); border: 1px dashed var(--color-border); border-radius: var(--border-radius-sm); min-height: 250px; display: flex; align-items: center; justify-content: center; color: var(--color-text-muted); font-style: italic; }

        .quick-links-list { list-style: none; padding: 0;}
        .quick-links-list li a { display: block; padding: 0.75rem 0; color: var(--color-primary); font-weight: 500; border-bottom: 1px dashed var(--color-border); }
        .quick-links-list li:last-child a { border-bottom: none; }
        .quick-links-list li a:hover { background-color: var(--color-bg-alt); padding-left: 0.5rem; }

        .valid-emails-display-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; margin-bottom: 1rem; border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); }
        .valid-emails-display-list li { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--color-border); font-size: 0.9rem; color: var(--color-text); }
        .valid-emails-display-list li:last-child { border-bottom: none; }
        .valid-emails-display-list li:nth-child(odd) { background-color: var(--color-bg-alt); }
        .dark-theme .valid-emails-display-list li:nth-child(odd) { background-color: var(--color-surface); }

        /* --- Validation Log Page Specific Styles --- */
        .log-controls { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;}
        .log-controls label { margin-right: 0.5rem; font-weight: 500;}
        .log-controls select, .log-controls input[type="text"] {
            padding: 0.5em; border: 1px solid var(--color-border); border-radius: var(--border-radius-sm);
            background-color: var(--color-bg); color: var(--color-text);
        }
        #validationLogTable th[data-sort] { cursor: pointer; } /* from log */
        #validationLogTable th[data-sort]:hover { color: var(--color-primary); } /* from log */
        
        /* Footer */
        .footer {
            padding: 40px 0;
            background-color: var(--color-surface); 
            border-top: 1px solid var(--color-border);
            text-align: center;
            margin-top: auto; 
        }
        .footer p { margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--color-text-muted); }
        .footer .navbar-brand { font-size: 1.5rem; display: inline-block; margin-bottom: 0.5rem;}


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .navbar-nav {
                display: none; flex-direction: column; width: 100%;
                background-color: var(--color-surface);
                position: absolute; top: 100%; left: 0;
                padding: 1rem 0; box-shadow: var(--shadow-md);
                text-align: center; gap: 0.5rem;
                border-top: 1px solid var(--color-border);
            }
            .navbar-nav.active { display: flex; }
            .navbar-nav li { margin: 0.5rem 0; }
            .navbar-toggler { display: block; }

            .page-header h1 { font-size: clamp(1.8rem, 4vw, 2.5rem); } /* applies to all page headers */
            
            /* Home page responsive */
            .tool-cards-grid { grid-template-columns: 1fr; }

            /* Finder/Verifier/Log responsive */
            .results-table th, .results-table td { font-size: 0.9rem; padding: 0.5rem; }
            .results-section h2 .btn-copy { font-size: 0.8rem; padding: 0.3em 0.6em;}
            
            /* Dashboard responsive */
            .stats-grid { grid-template-columns: 1fr; } 

            /* Log responsive */
            #validationLogTable th, #validationLogTable td { font-size: 0.85rem; padding: 0.4rem; }
            #validationLogTable td.status-cell span { font-size: 0.8em; }
            .log-controls { flex-direction: column; align-items: stretch;}
            .log-controls > div { margin-bottom: 0.5rem; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="javascript:showPage('home-page-content');" class="navbar-brand">LeadSpark</a>
            <button class="navbar-toggler" aria-label="Toggle navigation" aria-expanded="false">
                <span>☰</span> <!-- Hamburger Icon -->
            </button>
            <ul class="navbar-nav">
                <li><a href="javascript:showPage('home-page-content');" data-page="home-page-content" class="nav-link">Home</a></li> 
                <li><a href="javascript:showPage('email-finder-page-content');" data-page="email-finder-page-content" class="nav-link">Email Finder</a></li>
                <li><a href="javascript:showPage('email-verifier-page-content');" data-page="email-verifier-page-content" class="nav-link">Email Verifier</a></li>
                <li><a href="javascript:showPage('dashboard-page-content');" data-page="dashboard-page-content" class="nav-link">Dashboard</a></li> 
                <li><a href="javascript:showPage('validation-log-page-content');" data-page="validation-log-page-content" class="nav-link">Validation Log</a></li>
                <li><a href="javascript:showPage('settings-page-content');" data-page="settings-page-content" class="nav-link">Settings</a></li>
                <li>
                    <button class="theme-toggle-btn" id="themeToggle" aria-label="Toggle theme">
                        ☀️ <!-- JS will set initial icon -->
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <!-- Home Page Content -->
        <div id="home-page-content" class="page-content">
            <header class="page-header home-header"> 
                <div class="container">
                    <h1>Welcome to Your LeadSpark Home!</h1> 
                    <p>Quickly access your email tools and manage your leads.</p>
                </div>
            </header>

            <section id="tool-access" class="tool-access-section section">
                <div class="container">
                    <h2>Your Tools</h2>
                    <div class="tool-cards-grid">
                        <div class="tool-card">
                            <h3><span style="color: var(--color-primary);">🚀</span> Email Finder</h3>
                            <p>Discover targeted email addresses from company domains or professional names to expand your outreach.</p>
                            <div class="form-group">
                                <input type="text" class="form-input" placeholder="Enter domain or name (e.g., company.com)">
                            </div>
                            <a href="javascript:showPage('email-finder-page-content');" class="btn btn-primary home-launch-finder">Launch Email Finder</a>
                        </div>
                        <div class="tool-card">
                            <h3><span style="color: var(--color-accent);">✔️</span> Email Verifier</h3>
                            <p>Ensure deliverability and reduce bounce rates by verifying individual emails or entire lists.</p>
                            <div class="form-group">
                                <input type="email" class="form-input" placeholder="Enter email to verify (e.g., name@example.com)">
                            </div>
                            <a href="javascript:showPage('email-verifier-page-content');" class="btn btn-secondary home-launch-verifier">Launch Email Verifier</a>
                        </div>
                    </div>
                </div>
            </section>

            <section id="recent-activity" class="recent-activity-section section">
                <div class="container">
                    <h2>Recent Activity</h2>
                    <div class="activity-item">
                        <p><strong>Searched:</strong> coolcompany.com (5 emails found)</p>
                        <span class="timestamp">2 hours ago</span>
                    </div>
                    <div class="activity-item">
                        <p><strong>Verified:</strong> contact@example.org (Status: Valid)</p>
                        <span class="timestamp">Yesterday</span>
                    </div>
                    <div class="activity-item">
                        <p><strong>Exported:</strong> "Tech Leads Q3" list</p>
                        <span class="timestamp">3 days ago</span>
                    </div>
                    <p class="text-center" style="margin-top: 2rem;"><a href="javascript:showPage('validation-log-page-content');" id="homeViewAllActivityLink">View All Activity →</a></p>
                </div>
            </section>
        </div>

        <!-- Email Finder Page Content -->
        <div id="email-finder-page-content" class="page-content">
            <header class="page-header tool-page-header"> 
                <div class="container">
                    <h1><span style="color: var(--color-primary);">💡</span> Email Permutator & Finder</h1> 
                    <p>Generate and check potential email addresses for your contacts using validate.email API.</p>
                </div>
            </header>

            <section id="email-finder-tool" class="section">
                <div class="container">
                    <form class="form-section finder-form-section" id="bulkFinderForm">
                        <div class="form-group">
                            <label for="finder-domain" class="form-label">Company Domain</label>
                            <input type="text" id="finder-domain" name="finder-domain" class="form-input" placeholder="e.g., company.com" required>
                            <p class="form-note">Enter the website domain of the company.</p>
                        </div>
                        <div class="form-group">
                            <label for="finder-names" class="form-label">Names (One per line: First Last)</label>
                            <textarea id="finder-names" name="finder-names" class="form-textarea" rows="5" placeholder="e.g.,
Rohan Patel
Jane Doe
David Lee" required></textarea>
                            <p class="form-note">Enter full names. Each name on a new line.</p>
                        </div>
                        <button type="submit" class="btn btn-primary">Generate & Check Emails</button>
                    </form>

                    <div class="results-section">
                        <h2>
                            Results 
                            <button class="btn btn-secondary btn-copy" id="copyAllValidButton" data-original-text='Copy All "Valid" Emails' style="display:none;">Copy All "Valid" Emails</button>
                        </h2>
                        <div id="finder-results-area">
                            <div class="results-placeholder" id="results-initial-placeholder">
                                <p>Enter a domain and list of names above, then click "Generate & Check Emails" to see results here.</p>
                            </div>
                            <table class="results-table" id="resultsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Name Searched</th>
                                        <th>"Validated" Emails (via API)</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Email Verifier Page Content -->
        <div id="email-verifier-page-content" class="page-content">
            <header class="page-header tool-page-header"> 
                <div class="container">
                    <h1><span style="color: var(--color-secondary);">✔️</span> Email Verifier</h1> 
                    <p>Check the validity of email addresses using validate.email API.</p>
                </div>
            </header>

            <section id="email-verifier-tool" class="section">
                <div class="container">
                    <form class="form-section verifier-form-section" id="bulkVerifierForm">
                        <div class="form-group">
                            <label for="verifier-emails" class="form-label">Emails to Verify (One per line)</label>
                            <textarea id="verifier-emails" name="verifier-emails" class="form-textarea" rows="8" placeholder="e.g.,
test@example.com
another@domain.co
invalid-email" required></textarea>
                            <p class="form-note">Paste your list of email addresses here. Each email on a new line.</p>
                        </div>
                        <button type="submit" class="btn btn-primary">Verify Emails</button>
                    </form>

                    <div class="results-section">
                        <h2>
                            Verification Results
                            <button class="btn btn-secondary btn-copy" id="copyValidVerifiedButton" data-original-text="Copy Valid Only" style="display:none;">Copy Valid Only</button>
                        </h2>
                        <div id="verifier-results-area">
                            <div class="results-placeholder" id="verifier-results-initial-placeholder">
                                <p>Enter a list of emails above and click "Verify Emails" to see results here.</p>
                            </div>
                            <table class="results-table" id="verifierResultsTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Email Address</th>
                                        <th>Status</th>
                                        <th>Details (from API)</th>
                                    </tr>
                                </thead>
                                <tbody id="verifierResultsTableBody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Dashboard Page Content -->
        <div id="dashboard-page-content" class="page-content">
             <header class="page-header dashboard-page-header"> 
                <div class="container">
                    <h1>Your LeadSpark Dashboard</h1> 
                    <p>Overview of your email finding and verification activities.</p>
                </div>
            </header>

            <section id="dashboard-content" class="section">
                <div class="container">
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <span class="stat-card-value" id="statTotalFound">0</span>
                            <span class="stat-card-label">Total Emails Found (Session)</span>
                        </div>
                        <div class="stat-card secondary">
                            <span class="stat-card-value" id="statTotalVerified">0</span>
                            <span class="stat-card-label">Total Emails Verified (Log)</span>
                        </div>
                        <div class="stat-card accent">
                            <span class="stat-card-value" id="statValidEmails">0</span>
                            <span class="stat-card-label">Valid Emails (Log)</span>
                        </div>
                        <div class="stat-card primary">
                            <span class="stat-card-value" id="statRiskyEmails">0</span>
                            <span class="stat-card-label">Risky Emails (Log)</span>
                        </div>
                    </div>

                    <div class="dashboard-content-grid">
                        <div class="dashboard-panel">
                            <h3>
                                Recently Found Valid Emails
                                <button class="btn btn-sm btn-secondary btn-copy" id="copyDisplayedValidButton" data-original-text="Copy Displayed" style="display:none;">Copy Displayed</button>
                            </h3>
                            <div id="dashboardValidEmailsListContainer">
                                <p id="noValidEmailsMessage">No recently found valid emails to display from verifier.</p>
                                <ul class="valid-emails-display-list" id="dashboardValidEmailsList" style="display:none;">
                                    <!-- JS will populate this -->
                                </ul>
                            </div>
                             <button class="btn btn-sm btn-primary" id="clearStoredEmailsButton" style="margin-top:1rem; display:none;">Clear Stored Valid Emails</button>
                        </div>

                        <div class="dashboard-panel">
                            <h3>Recent Activity (Log Summary)</h3>
                             <ul class="activity-list" id="recentActivityList">
                                 <!-- JS will populate this from log -->
                                 <li class="activity-item" id="noRecentActivityMessageDashboard"><p>No recent verification activity logged.</p></li>
                            </ul>
                            <p style="margin-top: 1rem; text-align:right;"><a href="javascript:showPage('validation-log-page-content');" class="btn btn-sm btn-secondary dashboard-view-all-activity">View Full Log</a></p>
                        </div>

                        <div class="dashboard-panel">
                            <h3>Quick Links</h3>
                            <ul class="quick-links-list">
                                <li><a href="javascript:showPage('email-finder-page-content');" class="dashboard-ql-finder">🚀 Go to Email Finder</a></li>
                                <li><a href="javascript:showPage('email-verifier-page-content');" class="dashboard-ql-verifier">✔️ Go to Email Verifier</a></li>
                                <li><a href="#reports">📊 View Reports (Coming Soon)</a></li>
                                <li><a href="#settings">⚙️ Account Settings (Coming Soon)</a></li>
                            </ul>
                        </div>

                        <div class="dashboard-panel">
                            <h3>Verification Stats (Placeholder)</h3>
                            <div class="chart-placeholder">
                                <p>Chart: Verification Status Breakdown</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Validated Emails Log Page Content -->
        <div id="validation-log-page-content" class="page-content">
            <header class="page-header tool-page-header"> 
                <div class="container">
                    <h1><span style="color: var(--color-accent);">🗂️</span> Validated Emails Log</h1> 
                    <p>A complete history of your email verification activities.</p>
                </div>
            </header>

            <section id="validation-log-content" class="section">
                <div class="container">
                    <div class="results-section">
                        <div class="log-controls">
                            <div>
                                <label for="statusFilter">Filter by Status:</label>
                                <select id="statusFilter">
                                    <option value="all">All Statuses</option>
                                    <option value="Valid">Valid</option>
                                    <option value="Invalid">Invalid</option>
                                    <option value="Risky">Risky</option>
                                    <option value="Unknown">Unknown</option>
                                </select>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-secondary btn-copy" id="copyLogButton" data-original-text="Copy Displayed Log" style="display:none;">Copy Displayed Log</button>
                                <button class="btn btn-sm btn-danger" id="clearLogButton" style="margin-left: 0.5rem;">Clear Entire Log</button>
                            </div>
                        </div>

                        <div id="validation-log-area">
                            <div class="results-placeholder" id="log-initial-placeholder">
                                <p>Your verification log will appear here. Verify some emails to get started!</p>
                            </div>
                            <table class="results-table" id="validationLogTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th data-sort="email">Email Address</th>
                                        <th data-sort="status">Status</th>
                                        <th data-sort="detail">Details</th>
                                        <th data-sort="timestamp">Date Verified</th>
                                    </tr>
                                </thead>
                                <tbody id="validationLogTableBody">
                                    <!-- JS will populate this -->
                                </tbody>
                            </table>
                             <p id="logCount" style="text-align: right; margin-top: 1rem; font-size: 0.9em; color: var(--color-text-muted);"></p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Settings Page Content -->
    <div id="settings-page-content" class="page-content">
        <header class="page-header tool-page-header"> 
            <div class="container">
                <h1><span style="color: var(--color-secondary);">⚙️</span> API Settings</h1> 
                <p>Configure API settings for email validation services.</p>
            </div>
        </header>

        <section id="settings-content" class="section">
            <div class="container">
                <form class="form-section" id="apiSettingsForm">
                    <h3 style="margin-bottom: 1.5rem; color: var(--color-primary);">Email Validation API Settings</h3>
                    
                    <div class="form-group">
                        <label class="form-label">API Provider</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
                            <div>
                                <input type="radio" id="api-provider-validate-email" name="api-provider" value="validate-email">
                                <label for="api-provider-validate-email">validate.email - Detailed validation (https://api.validate.email/validate)</label>
                            </div>
                            <div>
                                <input type="radio" id="api-provider-bazzigate" name="api-provider" value="bazzigate" checked>
                                <label for="api-provider-bazzigate">Bazzigate - Simple validation (https://emailverifiers-backend.bazzigate.com)</label>
                            </div>
                            <div>
                                <input type="radio" id="api-provider-supersend" name="api-provider" value="supersend">
                                <label for="api-provider-supersend">SuperSend - Balanced validation (https://api.supersend.io/v1/verify-email)</label>
                            </div>
                        </div>
                        <p class="form-note">Select which API provider to use for email validation.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="api-url" class="form-label">API Endpoint URL</label>
                        <input type="url" id="api-url" name="api-url" class="form-input" placeholder="https://emailverifiers-backend.bazzigate.com/single-email-varification">
                        <p class="form-note">The base URL for the email validation API. Will update when you change providers.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="api-key" class="form-label">API Key</label>
                        <input type="text" id="api-key" name="api-key" class="form-input" placeholder="Enter your API key if required">
                        <p class="form-note">Leave blank if your API doesn't require authentication.</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="max-parallel-requests" class="form-label">Max Parallel Requests</label>
                        <input type="number" id="max-parallel-requests" name="max-parallel-requests" class="form-input" min="1" max="100" placeholder="50">
                        <p class="form-note">Maximum number of parallel API requests to make at once.</p>
                    </div>

                    <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--color-border);">
                    
                    <h3 style="margin-bottom: 1.5rem; color: var(--color-secondary);">Email Finder Settings</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Email Patterns to Generate</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.5rem;">
                            <div>
                                <input type="checkbox" id="pattern-first" name="email-patterns" value="first" checked>
                                <label for="pattern-first">first@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-last" name="email-patterns" value="last" checked>
                                <label for="pattern-last">last@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-firstlast" name="email-patterns" value="firstlast" checked>
                                <label for="pattern-firstlast">firstlast@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-lastfirst" name="email-patterns" value="lastfirst">
                                <label for="pattern-lastfirst">lastfirst@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-first-dot-last" name="email-patterns" value="first.last" checked>
                                <label for="pattern-first-dot-last">first.last@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-last-dot-first" name="email-patterns" value="last.first">
                                <label for="pattern-last-dot-first">last.first@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-first-underscore-last" name="email-patterns" value="first_last" checked>
                                <label for="pattern-first-underscore-last">first_last@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-last-underscore-first" name="email-patterns" value="last_first">
                                <label for="pattern-last-underscore-first">last_first@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-first-dash-last" name="email-patterns" value="first-last" checked>
                                <label for="pattern-first-dash-last">first-last@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-last-dash-first" name="email-patterns" value="last-first">
                                <label for="pattern-last-dash-first">last-first@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-firstinitial-last" name="email-patterns" value="flast" checked>
                                <label for="pattern-firstinitial-last">flast@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-firstinitial-dot-last" name="email-patterns" value="f.last" checked>
                                <label for="pattern-firstinitial-dot-last">f.last@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-first-lastinitial" name="email-patterns" value="first.l" checked>
                                <label for="pattern-first-lastinitial">first.l@domain.com</label>
                            </div>
                            <div>
                                <input type="checkbox" id="pattern-firstinitial-lastinitial" name="email-patterns" value="fl" checked>
                                <label for="pattern-firstinitial-lastinitial">fl@domain.com</label>
                            </div>
                        </div>
                        <p class="form-note">Select which email patterns to generate when using the Email Finder tool. Only checked patterns will be generated and verified.</p>
                    </div>

                    <div class="form-group">
                        <button type="button" id="select-all-patterns" class="btn btn-sm btn-secondary" style="margin-right: 0.5rem;">Select All</button>
                        <button type="button" id="deselect-all-patterns" class="btn btn-sm btn-secondary">Deselect All</button>
                    </div>

                    <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--color-border);">

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                        <button type="button" id="reset-default-settings" class="btn btn-secondary" style="margin-top: 1rem;">Reset to Defaults</button>
                    </div>
                </form>

                <div class="results-section" style="margin-top: 2rem;">
                    <h2>Testing</h2>
                    <div class="form-group">
                        <label for="test-email" class="form-label">Test Email Validation</label>
                        <div style="display: flex; gap: 1rem;">
                            <input type="email" id="test-email" class="form-input" placeholder="Enter an email to test API" style="flex: 1;">
                            <button type="button" id="test-api-btn" class="btn btn-secondary">Test API</button>
                        </div>
                    </div>
                    <div id="test-results" style="margin-top: 1rem; padding: 1rem; border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); background-color: var(--color-bg-alt); display: none;">
                        <pre id="test-results-content" style="margin: 0; white-space: pre-wrap; font-size: 0.9rem; font-family: monospace;"></pre>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <a href="javascript:showPage('home-page-content');" class="navbar-brand">LeadSpark</a>
            <p>© <span id="currentYear"></span> LeadSpark Tools. Your personal email toolkit.</p>
            <p><a href="#privacy">Privacy Policy</a> | <a href="#terms">Terms of Service</a></p>
        </div>
    </footer>

    <script>
        // --- Global Variables and Elements ---
        const allPageContents = document.querySelectorAll('.page-content');
        const navLinks = document.querySelectorAll('.navbar-nav .nav-link');
        const mainNavbarToggler = document.querySelector('.navbar-toggler');
        const mainNavbarNav = document.querySelector('.navbar-nav');
        const mainThemeToggleBtn = document.getElementById('themeToggle');
        const mainCurrentYearSpan = document.getElementById('currentYear');
        const sunIcon = '☀️'; 
        const moonIcon = '🌙';
        
        // --- API Integration ---
        let VALIDATE_EMAIL_API_URL = 'https://emailverifiers-backend.bazzigate.com/single-email-varification';
        let MAX_PARALLEL_REQUESTS_PER_CHUNK = 50; 

        // --- Utility: Show "Copied!" message on buttons ---
        function showCopiedFeedback(buttonElement) {
            const originalText = buttonElement.dataset.originalText || buttonElement.textContent;
            buttonElement.textContent = 'Copied!';
            buttonElement.classList.add('copied');
            buttonElement.disabled = true;

            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.classList.remove('copied');
                buttonElement.disabled = false;
            }, 1500);
        }

        async function callValidateEmailAPI(email) {
            try {
                const response = await fetch(`${VALIDATE_EMAIL_API_URL}?email=${encodeURIComponent(email)}`, {
                    headers: {
                        'accept': 'application/json'
                    }
                });
                if (!response.ok) {
                    console.error(`API error for ${email}: ${response.status} ${response.statusText}`);
                    try {
                        const errorData = await response.json();
                        console.error('API error data:', errorData);
                        return { error: true, message: errorData.message || `HTTP error ${response.status}`, apiData: null, originalEmail: email };
                    } catch (e) {
                         return { error: true, message: `HTTP error ${response.status}`, apiData: null, originalEmail: email };
                    }
                }
                const data = await response.json();
                return { error: false, apiData: data, originalEmail: email };
            } catch (error) {
                console.error(`Network or other error validating ${email}:`, error);
                return { error: true, message: error.message || 'Network error', apiData: null, originalEmail: email };
            }
        }
        
        function mapApiResponseToIsValid(apiResponseData) { // For Email Finder
            if (!apiResponseData) return false;
            
            // Get current API provider from settings
            const storedSettings = localStorage.getItem('leadSparkSettings');
            let apiProvider = 'bazzigate'; // Default
            
            if (storedSettings) {
                try {
                    const settings = JSON.parse(storedSettings);
                    apiProvider = settings.apiProvider || 'bazzigate';
                } catch (e) {
                    console.error('Failed to parse stored settings:', e);
                }
            }
            
            switch (apiProvider) {
                case 'validate-email':
                    // validate.email API
                    if (!apiResponseData.result) return false;
                    const res = apiResponseData.result;
                    // Only consider syntax validity and "safe" reachability
                    return res.syntax && res.syntax.valid && res.reachable === 'safe';
                    
                case 'bazzigate':
                    // Bazzigate API returns { res: boolean, email: string }
                    return apiResponseData.res === true;
                    
                case 'supersend':
                    // SuperSend API
                    return apiResponseData.valid === true;
                    
                default:
                    return false;
            }
        }

        function mapApiResponseToStatusDetails(apiResponseData) { // For Email Verifier
            if (!apiResponseData) {
                return { status: 'Unknown', detail: 'API error or no result received.' };
            }
            
            // Get current API provider from settings
            const storedSettings = localStorage.getItem('leadSparkSettings');
            let apiProvider = 'bazzigate'; // Default
            
            if (storedSettings) {
                try {
                    const settings = JSON.parse(storedSettings);
                    apiProvider = settings.apiProvider || 'bazzigate';
                } catch (e) {
                    console.error('Failed to parse stored settings:', e);
                }
            }
            
            switch (apiProvider) {
                case 'validate-email':
                    // validate.email API
                    if (!apiResponseData.result) {
                        return { status: 'Unknown', detail: 'API error or no result received.' };
                    }
                    
                    const res = apiResponseData.result;
                    let status = 'Unknown'; // Default
                    let detailParts = new Set(); // Use Set to avoid duplicate reasons

                    // Determine status primarily by 'reachable' field
                    if (res.reachable === 'safe') {
                        status = 'Valid';
                        // Still collect info about the email for details, but don't change Valid status
                        if (res.disposable === true) {
                            detailParts.add('Disposable email address.');
                        }
                        if (res.smtp && res.smtp.is_catch_all === true) {
                            detailParts.add('Domain is catch-all.');
                        }
                        if (res.domain && !res.domain.spf) {
                            detailParts.add('Domain does not have an SPF record.');
                        }
                        if (res.domain && res.domain.age < 180) {
                            detailParts.add('Domain age is less than 180 days.');
                        }
                        if (res.riskScore && res.riskScore.score >= 70) {
                            detailParts.add(`High risk score: ${res.riskScore.score}.`);
                        }
                    } else if (res.reachable === 'invalid') {
                        status = 'Invalid';
                        if (res.smtp && res.smtp.is_disabled === true) {
                            detailParts.add('Account disabled or does not exist.');
                        } else if (res.smtp && res.smtp.is_deliverable === false) {
                            detailParts.add('Email address not deliverable by SMTP.');
                        } else {
                            detailParts.add('Email address is invalid.');
                        }
                    } else if (res.reachable === 'risky') {
                        status = 'Risky';
                        if (res.disposable === true) detailParts.add('Disposable email address.');
                        if (res.riskScore && res.riskScore.reasons && Array.isArray(res.riskScore.reasons)) {
                            res.riskScore.reasons.forEach(reason => detailParts.add(reason));
                        }
                    } else if (res.reachable === 'unknown') {
                        status = 'Unknown';
                        detailParts.add('Email reachability is unknown.');
                    }

                    // The only case when we should override the reachable field is for syntax errors
                    if (!res.syntax || !res.syntax.valid) {
                        status = 'Invalid';
                        detailParts.clear(); // Clear other reasons if syntax is bad
                        detailParts.add('Invalid email syntax.');
                    }
                    
                    let detail = Array.from(detailParts).filter(dp => typeof dp === 'string' && dp.trim() !== '').join('; ');
                    if (!detail && status === 'Valid') detail = 'Mailbox appears valid and deliverable.';
                    else if (!detail && status === 'Risky') detail = 'Email has risk factors identified.';
                    else if (!detail && status === 'Unknown') detail = 'Could not conclusively determine status.';
                    else if (!detail && status === 'Invalid') detail = 'Email is invalid or undeliverable.';
                    
                    return { status, detail: detail || "No specific details provided by API." };
                    
                case 'bazzigate':
                    // Bazzigate API returns simple boolean result
                    if (apiResponseData.res === true) {
                        return { 
                            status: 'Valid', 
                            detail: 'Email address is valid and deliverable.'
                        };
                    } else {
                        return { 
                            status: 'Invalid', 
                            detail: 'Email address is invalid or undeliverable.'
                        };
                    }
                    
                case 'supersend':
                    // SuperSend API
                    if (apiResponseData.valid === true) {
                        return {
                            status: 'Valid',
                            detail: apiResponseData.message || 'Email address is valid and deliverable.'
                        };
                    } else {
                        // SuperSend has a special case for uncertain results
                        if (apiResponseData.message && apiResponseData.message.includes('Uncertain')) {
                            return {
                                status: 'Risky',
                                detail: apiResponseData.message || 'Email validation is uncertain.'
                            };
                        } else {
                            return {
                                status: 'Invalid',
                                detail: apiResponseData.message || 'Email address is invalid or undeliverable.'
                            };
                        }
                    }
                    
                default:
                    return { status: 'Unknown', detail: 'Unknown API provider.' };
            }
        }


        // --- Page Navigation Logic ---
        function showPage(pageId) {
            allPageContents.forEach(page => {
                page.style.display = 'none';
                page.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
            }

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active');
                }
            });

            let pageTitle = "LeadSpark";
            if (pageId === 'home-page-content') pageTitle = "LeadSpark - Home";
            else if (pageId === 'email-finder-page-content') pageTitle = "LeadSpark - Email Finder";
            else if (pageId === 'email-verifier-page-content') pageTitle = "LeadSpark - Email Verifier";
            else if (pageId === 'dashboard-page-content') pageTitle = "LeadSpark - Dashboard";
            else if (pageId === 'validation-log-page-content') pageTitle = "LeadSpark - Validation Log";
            document.title = pageTitle;
            
            window.scrollTo(0, 0); 

            if (pageId === 'dashboard-page-content') {
                 if (typeof dashboard_loadAndDisplayValidEmails === 'function') dashboard_loadAndDisplayValidEmails();
                 if (typeof dashboard_updateStats === 'function') dashboard_updateStats();
                 if (typeof dashboard_loadRecentActivity === 'function') dashboard_loadRecentActivity();
            }
            if (pageId === 'validation-log-page-content' && typeof validationLog_loadAndDisplayLog === 'function') {
                validationLog_loadAndDisplayLog();
            }
        }

        // --- Common JS: Theme Toggle, Navbar Toggle, Set Current Year ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                if (mainThemeToggleBtn) mainThemeToggleBtn.textContent = sunIcon;
            } else {
                document.body.classList.remove('dark-theme');
                if (mainThemeToggleBtn) mainThemeToggleBtn.textContent = moonIcon;
            }
        }
        function setupTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) { applyTheme(savedTheme); } 
            else { applyTheme(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'); }
            if (mainThemeToggleBtn) {
                mainThemeToggleBtn.addEventListener('click', () => {
                    let newTheme = document.body.classList.contains('dark-theme') ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme); applyTheme(newTheme);
                });
            }
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    const newColorScheme = event.matches ? "dark" : "light";
                    const storedTheme = localStorage.getItem('theme');
                    if (!storedTheme || storedTheme === newColorScheme) { 
                        applyTheme(newColorScheme);
                        if(storedTheme !== newColorScheme) localStorage.setItem('theme', newColorScheme); 
                    }
                });
            }
        }
        function setupNavbarToggle() {
            if (mainNavbarToggler && mainNavbarNav) {
                mainNavbarToggler.addEventListener('click', () => {
                    const isExpanded = mainNavbarToggler.getAttribute('aria-expanded') === 'true' || false;
                    mainNavbarToggler.setAttribute('aria-expanded', String(!isExpanded));
                    mainNavbarNav.classList.toggle('active');
                    mainNavbarToggler.innerHTML = mainNavbarNav.classList.contains('active') ? '<span>×</span>' : '<span>☰</span>';
                });
                mainNavbarNav.querySelectorAll('a.nav-link, .navbar-brand').forEach(link => {
                    link.addEventListener('click', (e) => {
                         if (mainNavbarNav.classList.contains('active') && window.innerWidth <= 768) {
                            if (!e.target.closest('.theme-toggle-btn') && e.target.id !== 'themeToggle') {
                                mainNavbarNav.classList.remove('active');
                                mainNavbarToggler.setAttribute('aria-expanded', 'false');
                                mainNavbarToggler.innerHTML = '<span>☰</span>';
                            }
                        }
                    });
                });
            }
        }
        function setCurrentYear() {
            if (mainCurrentYearSpan) { mainCurrentYearSpan.textContent = new Date().getFullYear(); }
        }

        // --- Email Finder Page JS ---
        function initEmailFinderScripts() {
            const bulkFinderForm = document.getElementById('bulkFinderForm');
            const resultsInitialPlaceholder = document.getElementById('results-initial-placeholder');
            const resultsTable = document.getElementById('resultsTable');
            const resultsTableBody = document.getElementById('resultsTableBody');
            const copyAllValidButton = document.getElementById('copyAllValidButton');
            let allFoundValidEmailsAcrossSearch = []; 

            function generateEmailPermutations(firstName, lastName, domain) {
                if (!firstName || !domain) return [];
                firstName = firstName.toLowerCase().replace(/[^a-z0-9]/g, ''); 
                lastName = lastName ? lastName.toLowerCase().replace(/[^a-z0-9]/g, '') : '';
                domain = domain.toLowerCase();
                
                // Get selected patterns from settings
                const storedSettings = localStorage.getItem('leadSparkSettings');
                let enabledPatterns = [];
                
                if (storedSettings) {
                    try {
                        const settings = JSON.parse(storedSettings);
                        enabledPatterns = settings.emailPatterns || [];
                    } catch (e) {
                        console.error('Failed to parse stored settings for email patterns:', e);
                        enabledPatterns = [
                            'first', 'last', 'firstlast', 'first.last', 'first_last', 
                            'first-last', 'flast', 'f.last', 'first.l', 'fl'
                        ];
                    }
                } else {
                    enabledPatterns = [
                        'first', 'last', 'firstlast', 'first.last', 'first_last', 
                        'first-last', 'flast', 'f.last', 'first.l', 'fl'
                    ];
                }
                
                const permutations = new Set(); 
                const f = firstName; const l = lastName; const fi = f.charAt(0); const li = l ? l.charAt(0) : '';

                // Only add permutations for enabled patterns
                if (enabledPatterns.includes('first')) permutations.add(`${f}@${domain}`);
                if (l && enabledPatterns.includes('last')) permutations.add(`${l}@${domain}`);
                if (l && enabledPatterns.includes('firstlast')) permutations.add(`${f}${l}@${domain}`);
                if (l && enabledPatterns.includes('lastfirst')) permutations.add(`${l}${f}@${domain}`);
                if (l && enabledPatterns.includes('first.last')) permutations.add(`${f}.${l}@${domain}`);
                if (l && enabledPatterns.includes('last.first')) permutations.add(`${l}.${f}@${domain}`);
                if (l && enabledPatterns.includes('first_last')) permutations.add(`${f}_${l}@${domain}`);
                if (l && enabledPatterns.includes('last_first')) permutations.add(`${l}_${f}@${domain}`);
                if (l && enabledPatterns.includes('first-last')) permutations.add(`${f}-${l}@${domain}`);
                if (l && enabledPatterns.includes('last-first')) permutations.add(`${l}-${f}@${domain}`);
                if (l && enabledPatterns.includes('flast')) permutations.add(`${fi}${l}@${domain}`);
                if (l && enabledPatterns.includes('f.last')) permutations.add(`${fi}.${l}@${domain}`);
                if (l && enabledPatterns.includes('first.l')) permutations.add(`${f}.${li}@${domain}`);
                if (l && enabledPatterns.includes('fl')) permutations.add(`${fi}${li}@${domain}`);
                
                return Array.from(permutations);
            }

            async function processPermutationsWithAPI(allPermutations) {
                const allResults = [];
                // Use the global MAX_PARALLEL_REQUESTS_PER_CHUNK value directly, which is updated by settings
                const chunkSize = MAX_PARALLEL_REQUESTS_PER_CHUNK;
                
                for (let i = 0; i < allPermutations.length; i += chunkSize) {
                    const chunk = allPermutations.slice(i, i + chunkSize);
                    const promises = chunk.map(email => callValidateEmailAPI(email));
                    const settledResults = await Promise.allSettled(promises);

                    settledResults.forEach(settledResult => {
                        if (settledResult.status === 'fulfilled') {
                            const apiCallResult = settledResult.value;
                            const isValid = mapApiResponseToIsValid(apiCallResult.apiData);
                            allResults.push({ email: apiCallResult.originalEmail, isValid: isValid });
                        } else {
                            console.error(`API call rejected for one email in finder:`, settledResult.reason);
                        }
                    });
                    resultsInitialPlaceholder.innerHTML = `<p>Processed ${Math.min(i + chunkSize, allPermutations.length)} of ${allPermutations.length} permutations...</p>`;
                }
                return allResults;
            }

            if (bulkFinderForm) {
                bulkFinderForm.addEventListener('submit', async (event) => { 
                    event.preventDefault(); 
                    const domain = document.getElementById('finder-domain').value.trim();
                    const namesText = document.getElementById('finder-names').value.trim();
                    if (!domain || !namesText) { alert('Please enter both a domain and a list of names.'); return; }
                    const namesArray = namesText.split('\n').map(name => name.trim()).filter(name => name !== '');
                    if (namesArray.length === 0) { alert('Please enter at least one name in the list.'); return; }

                    resultsTableBody.innerHTML = ''; resultsTable.style.display = 'none'; 
                    copyAllValidButton.style.display = 'none'; allFoundValidEmailsAcrossSearch = []; 
                    
                    let totalPermutationsToProcess = [];
                    for (const fullName of namesArray) {
                        const nameParts = fullName.split(' ');
                        const firstName = nameParts[0]; const lastName = nameParts.slice(1).join(' '); 
                        const permutations = generateEmailPermutations(firstName, lastName, domain);
                        totalPermutationsToProcess.push(...permutations.map(p => ({name: fullName, email: p})));
                    }

                    if (totalPermutationsToProcess.length === 0) {
                        resultsInitialPlaceholder.innerHTML = `<p>No permutations generated. Check input.</p>`;
                        resultsInitialPlaceholder.style.display = 'block';
                        return;
                    }
                    
                    resultsInitialPlaceholder.innerHTML = `<p>Generating & checking ${totalPermutationsToProcess.length} permutations for ${namesArray.length} name(s) at <strong>${domain}</strong> via API... This may take a while.</p>`;
                    resultsInitialPlaceholder.style.display = 'block';

                    const uniqueEmailsToVerify = [...new Set(totalPermutationsToProcess.map(p => p.email))];
                    const apiValidationResults = await processPermutationsWithAPI(uniqueEmailsToVerify);
                    
                    const resultsByFullName = {};
                    namesArray.forEach(name => resultsByFullName[name] = []);

                    apiValidationResults.forEach(apiRes => {
                        const matchingNameEntries = totalPermutationsToProcess.filter(p => p.email === apiRes.email);
                        matchingNameEntries.forEach(entry => {
                            if (apiRes.isValid) {
                                if (!resultsByFullName[entry.name].includes(apiRes.email)) {
                                     resultsByFullName[entry.name].push(apiRes.email);
                                }
                                if (!allFoundValidEmailsAcrossSearch.includes(apiRes.email)) {
                                    allFoundValidEmailsAcrossSearch.push(apiRes.email);
                                }
                            }
                        });
                    });
                    
                    for (const fullName of namesArray) {
                        const validEmailsForThisName = resultsByFullName[fullName] || [];
                        const row = resultsTableBody.insertRow();
                        row.insertCell().textContent = fullName;
                        const validEmailsCell = row.insertCell();
                        if (validEmailsForThisName.length > 0) {
                            const ul = document.createElement('ul'); ul.className = 'email-list';
                            validEmailsForThisName.forEach(email => {
                                const li = document.createElement('li'); li.className = 'valid-email'; li.textContent = email; ul.appendChild(li);
                            });
                            validEmailsCell.appendChild(ul);
                        } else { validEmailsCell.innerHTML = '<em>None found/validated by API</em>'; }

                        const actionsCell = row.insertCell();
                        if (validEmailsForThisName.length > 0) {
                            const copyBtn = document.createElement('button'); 
                            copyBtn.dataset.originalText = 'Copy';
                            copyBtn.textContent = 'Copy';
                            copyBtn.className = 'btn btn-secondary btn-copy';
                            copyBtn.onclick = (e) => {
                                navigator.clipboard.writeText(validEmailsForThisName.join('\n'))
                                    .then(() => showCopiedFeedback(e.target))
                                    .catch(err => console.error('Failed to copy emails: ', err));
                            };
                            actionsCell.appendChild(copyBtn);
                        } else { actionsCell.textContent = '-'; }
                    }

                    resultsInitialPlaceholder.style.display = 'none'; resultsTable.style.display = 'table'; 
                    if(allFoundValidEmailsAcrossSearch.length > 0) { copyAllValidButton.style.display = 'inline-block'; }
                    if (typeof dashboard_updateStats === 'function') dashboard_updateStats(); 
                });
            }
            if(copyAllValidButton) {
                copyAllValidButton.addEventListener('click', (e) => {
                    if(allFoundValidEmailsAcrossSearch.length > 0) {
                        navigator.clipboard.writeText(allFoundValidEmailsAcrossSearch.join('\n'))
                            .then(() => showCopiedFeedback(e.target))
                            .catch(err => console.error('Failed to copy all emails: ', err));
                    } else { 
                        e.target.textContent = "No emails!";
                        setTimeout(()=> e.target.textContent = e.target.dataset.originalText, 1500);
                    }
                });
            }
        }


        // --- Email Verifier Page JS ---
        function initEmailVerifierScripts() {
            const bulkVerifierForm = document.getElementById('bulkVerifierForm');
            const verifierResultsInitialPlaceholder = document.getElementById('verifier-results-initial-placeholder');
            const verifierResultsTable = document.getElementById('verifierResultsTable');
            const verifierResultsTableBody = document.getElementById('verifierResultsTableBody');
            const copyValidVerifiedButton = document.getElementById('copyValidVerifiedButton');
            let allVerifiedValidEmailsFromCurrentBatch = [];

            async function actualVerifyBatchEmails(emailsToVerify) {
                const allResults = [];
                // Use the global MAX_PARALLEL_REQUESTS_PER_CHUNK value directly, which is updated by settings
                const chunkSize = MAX_PARALLEL_REQUESTS_PER_CHUNK;
                
                for (let i = 0; i < emailsToVerify.length; i += chunkSize) {
                    const chunk = emailsToVerify.slice(i, i + chunkSize);
                    const promises = chunk.map(email => callValidateEmailAPI(email));
                    const settledResults = await Promise.allSettled(promises);

                    settledResults.forEach(settledResult => {
                        let email, statusInfo;
                        if (settledResult.status === 'fulfilled') {
                            const apiCallResult = settledResult.value;
                            email = apiCallResult.originalEmail;
                            if (apiCallResult.error) {
                                statusInfo = { status: 'Unknown', detail: `API Call Failed: ${apiCallResult.message}` };
                            } else {
                                statusInfo = mapApiResponseToStatusDetails(apiCallResult.apiData);
                            }
                        } else {
                            console.error(`API call rejected for one email in verifier:`, settledResult.reason);
                            email = "Unknown email (promise rejected)"; 
                            statusInfo = { status: 'Unknown', detail: `Promise rejected` }; 
                        }
                        allResults.push({ 
                            email: email, 
                            status: statusInfo.status, 
                            detail: statusInfo.detail, 
                            timestamp: new Date().toISOString() 
                        });
                    });
                     verifierResultsInitialPlaceholder.innerHTML = `<p>Verified ${Math.min(i + chunkSize, emailsToVerify.length)} of ${emailsToVerify.length} emails...</p>`;
                }
                return allResults;
            }

            if (bulkVerifierForm) {
                bulkVerifierForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const emailsText = document.getElementById('verifier-emails').value.trim();
                    if (!emailsText) { alert('Please enter at least one email to verify.'); return; }
                    const emailsArray = [...new Set(emailsText.split('\n').map(email => email.trim()).filter(email => email !== ''))]; 
                    if (emailsArray.length === 0) { alert('Please enter valid email addresses.'); return; }

                    verifierResultsTableBody.innerHTML = ''; verifierResultsTable.style.display = 'none';
                    copyValidVerifiedButton.style.display = 'none'; allVerifiedValidEmailsFromCurrentBatch = [];
                    verifierResultsInitialPlaceholder.innerHTML = `<p>Verifying ${emailsArray.length} email(s) via API... This may take a while.</p>`;
                    verifierResultsInitialPlaceholder.style.display = 'block';

                    const verificationResults = await actualVerifyBatchEmails(emailsArray);
                    
                    let currentLog = JSON.parse(localStorage.getItem('leadSparkVerificationLog') || '[]');
                    currentLog.unshift(...verificationResults); 
                    localStorage.setItem('leadSparkVerificationLog', JSON.stringify(currentLog));

                    let currentGlobalValidEmails = JSON.parse(localStorage.getItem('leadSparkAllValidEmails') || '[]');
                    
                    verificationResults.forEach(result => {
                        const row = verifierResultsTableBody.insertRow();
                        row.insertCell().textContent = result.email;
                        const statusCell = row.insertCell(); statusCell.className = 'status-cell';
                        const statusSpan = document.createElement('span'); statusSpan.textContent = result.status;
                        statusSpan.className = `status-${result.status.toLowerCase()}`; statusCell.appendChild(statusSpan);
                        row.insertCell().textContent = result.detail;
                        if (result.status === 'Valid') {
                            allVerifiedValidEmailsFromCurrentBatch.push(result.email);
                            if (!currentGlobalValidEmails.includes(result.email)) { 
                                currentGlobalValidEmails.push(result.email);
                            }
                        }
                    });
                    localStorage.setItem('leadSparkAllValidEmails', JSON.stringify(currentGlobalValidEmails));

                    verifierResultsInitialPlaceholder.style.display = 'none'; verifierResultsTable.style.display = 'table';
                    if (allVerifiedValidEmailsFromCurrentBatch.length > 0) { copyValidVerifiedButton.style.display = 'inline-block'; }
                    
                    if (typeof dashboard_updateStats === 'function') dashboard_updateStats();
                    if (typeof dashboard_loadAndDisplayValidEmails === 'function') dashboard_loadAndDisplayValidEmails();
                    if (typeof dashboard_loadRecentActivity === 'function') dashboard_loadRecentActivity();
                });
            }
            if (copyValidVerifiedButton) {
                copyValidVerifiedButton.addEventListener('click', (e) => {
                    if (allVerifiedValidEmailsFromCurrentBatch.length > 0) {
                        navigator.clipboard.writeText(allVerifiedValidEmailsFromCurrentBatch.join('\n'))
                            .then(() => showCopiedFeedback(e.target))
                            .catch(err => console.error('Failed to copy emails: ', err));
                    } else { 
                        e.target.textContent = "No emails!";
                        setTimeout(()=> e.target.textContent = e.target.dataset.originalText, 1500);
                    }
                });
            }
        }

        // --- Dashboard Page JS ---
        const dashboard_dashboardValidEmailsList = document.getElementById('dashboardValidEmailsList');
        const dashboard_noValidEmailsMessage = document.getElementById('noValidEmailsMessage');
        const dashboard_copyDisplayedValidButton = document.getElementById('copyDisplayedValidButton');
        const dashboard_clearStoredEmailsButton = document.getElementById('clearStoredEmailsButton');
        let dashboard_displayedValidEmails = [];

        function dashboard_loadAndDisplayValidEmails() { 
            const storedEmailsJSON = localStorage.getItem('leadSparkAllValidEmails');
            dashboard_displayedValidEmails = []; 

            if (dashboard_dashboardValidEmailsList && dashboard_noValidEmailsMessage && dashboard_copyDisplayedValidButton && dashboard_clearStoredEmailsButton) {
                dashboard_dashboardValidEmailsList.innerHTML = ''; 
                const storedEmails = storedEmailsJSON ? JSON.parse(storedEmailsJSON) : [];
                if (storedEmails.length > 0) {
                    const emailsToDisplay = storedEmails.slice(-20).reverse(); 
                    emailsToDisplay.forEach(email => {
                        const li = document.createElement('li'); li.textContent = email;
                        dashboard_dashboardValidEmailsList.appendChild(li);
                        dashboard_displayedValidEmails.push(email); 
                    });
                    dashboard_dashboardValidEmailsList.style.display = 'block'; dashboard_noValidEmailsMessage.style.display = 'none';
                    dashboard_copyDisplayedValidButton.style.display = 'inline-block'; dashboard_clearStoredEmailsButton.style.display = 'inline-block';
                } else {
                    dashboard_dashboardValidEmailsList.style.display = 'none'; dashboard_noValidEmailsMessage.style.display = 'block';
                    dashboard_copyDisplayedValidButton.style.display = 'none'; dashboard_clearStoredEmailsButton.style.display = 'none';
                }
            }
        }
        if (dashboard_copyDisplayedValidButton) {
            dashboard_copyDisplayedValidButton.addEventListener('click', (e) => {
                if (dashboard_displayedValidEmails.length > 0) {
                    navigator.clipboard.writeText(dashboard_displayedValidEmails.join('\n'))
                        .then(() => showCopiedFeedback(e.target))
                        .catch(err => console.error('Failed to copy displayed emails: ', err));
                } else { 
                     e.target.textContent = "No emails!";
                     setTimeout(()=> e.target.textContent = e.target.dataset.originalText, 1500);
                }
            });
        }
        if (dashboard_clearStoredEmailsButton) {
            dashboard_clearStoredEmailsButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all stored valid emails from the verifier? This cannot be undone.')) {
                    localStorage.removeItem('leadSparkAllValidEmails');
                    dashboard_loadAndDisplayValidEmails(); 
                    dashboard_updateStats(); 
                    alert('Stored valid emails have been cleared.'); // Keep alert for destructive actions
                }
            });
        }
        function dashboard_updateStats() {
            const logData = JSON.parse(localStorage.getItem('leadSparkVerificationLog') || '[]');
            document.getElementById('statTotalVerified').textContent = logData.length;
            document.getElementById('statValidEmails').textContent = logData.filter(e => e.status === 'Valid').length;
            document.getElementById('statRiskyEmails').textContent = logData.filter(e => e.status === 'Risky').length;
        }
         function dashboard_loadRecentActivity() {
            const recentActivityList = document.getElementById('recentActivityList');
            const noActivityMessage = document.getElementById('noRecentActivityMessageDashboard');
            if (!recentActivityList || !noActivityMessage) return;

            const logData = JSON.parse(localStorage.getItem('leadSparkVerificationLog') || '[]');
            recentActivityList.innerHTML = ''; 

            if (logData.length === 0) {
                 recentActivityList.appendChild(noActivityMessage.cloneNode(true)); 
                 noActivityMessage.style.display = 'none'; 
                 recentActivityList.querySelector('#noRecentActivityMessageDashboard').style.display = 'list-item';
                 return;
            }
            if(recentActivityList.querySelector('#noRecentActivityMessageDashboard')){
                 recentActivityList.querySelector('#noRecentActivityMessageDashboard').style.display = 'none';
            }
            
            const recentItems = logData.slice(0, 5); 

            recentItems.forEach(item => {
                const li = document.createElement('li');
                li.className = 'activity-item';
                const p = document.createElement('p');
                p.textContent = `Verified: ${item.email} (Status: ${item.status})`;
                const span = document.createElement('span');
                span.className = 'timestamp';
                span.textContent = validationLog_formatDate(item.timestamp); 
                li.appendChild(p);
                li.appendChild(span);
                recentActivityList.appendChild(li);
            });
        }


        // --- Validated Emails Log Page JS ---
        const validationLog_logInitialPlaceholder = document.getElementById('log-initial-placeholder');
        const validationLog_validationLogTable = document.getElementById('validationLogTable');
        const validationLog_validationLogTableBody = document.getElementById('validationLogTableBody');
        const validationLog_statusFilter = document.getElementById('statusFilter');
        const validationLog_copyLogButton = document.getElementById('copyLogButton');
        const validationLog_clearLogButton = document.getElementById('clearLogButton');
        const validationLog_logCountElement = document.getElementById('logCount');
        let validationLog_fullLogData = []; 
        let validationLog_currentlyDisplayedLogData = [];

        function validationLog_formatDate(isoString) {
            if (!isoString) return 'N/A'; const date = new Date(isoString);
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' + 
                   date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit'});
        }
        function validationLog_renderLogTable(logEntries) {
            validationLog_validationLogTableBody.innerHTML = ''; 
            validationLog_currentlyDisplayedLogData = []; 
            if (logEntries.length === 0) {
                validationLog_validationLogTable.style.display = 'none';
                validationLog_logInitialPlaceholder.textContent = 'No verification records match your criteria or the log is empty.';
                validationLog_logInitialPlaceholder.style.display = 'block';
                validationLog_logCountElement.textContent = '';
                validationLog_copyLogButton.style.display = 'none'; return;
            }
            logEntries.forEach(entry => {
                const row = validationLog_validationLogTableBody.insertRow();
                row.insertCell().textContent = entry.email;
                const statusCell = row.insertCell(); statusCell.className = 'status-cell';
                const statusSpan = document.createElement('span'); statusSpan.textContent = entry.status;
                statusSpan.className = `status-${entry.status.toLowerCase()}`; statusCell.appendChild(statusSpan);
                row.insertCell().textContent = entry.detail || '-';
                row.insertCell().textContent = validationLog_formatDate(entry.timestamp);
                validationLog_currentlyDisplayedLogData.push(entry); 
            });
            validationLog_validationLogTable.style.display = 'table'; validationLog_logInitialPlaceholder.style.display = 'none';
            validationLog_logCountElement.textContent = `Showing ${logEntries.length} record(s).`;
            validationLog_copyLogButton.style.display = 'inline-block';
        }
        function validationLog_loadAndDisplayLog() {
            const storedLogJSON = localStorage.getItem('leadSparkVerificationLog');
            validationLog_fullLogData = storedLogJSON ? JSON.parse(storedLogJSON) : [];
            const selectedStatus = validationLog_statusFilter.value;
            let filteredLog = validationLog_fullLogData;
            if (selectedStatus !== 'all') {
                filteredLog = validationLog_fullLogData.filter(entry => entry.status === selectedStatus);
            }
            validationLog_renderLogTable(filteredLog);
        }
        if (validationLog_statusFilter) {
            validationLog_statusFilter.addEventListener('change', validationLog_loadAndDisplayLog);
        }
        if (validationLog_copyLogButton) {
            validationLog_copyLogButton.addEventListener('click', (e) => {
                if (validationLog_currentlyDisplayedLogData.length > 0) {
                    const textToCopy = validationLog_currentlyDisplayedLogData.map(entry => 
                        `${entry.email},${entry.status},"${(entry.detail || '').replace(/"/g, '""')}",${validationLog_formatDate(entry.timestamp)}`
                    ).join('\n');
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => showCopiedFeedback(e.target))
                        .catch(err => console.error('Failed to copy log: ', err));
                } else { 
                     e.target.textContent = "No log!";
                     setTimeout(()=> e.target.textContent = e.target.dataset.originalText, 1500);
                }
            });
        }
        if (validationLog_clearLogButton) {
            validationLog_clearLogButton.addEventListener('click', () => {
                if (confirm('Are you sure you want to clear the entire verification log? This action cannot be undone.')) {
                    localStorage.removeItem('leadSparkVerificationLog');
                    localStorage.removeItem('leadSparkAllValidEmails'); 
                    validationLog_fullLogData = []; 
                    validationLog_loadAndDisplayLog(); 
                    if (typeof dashboard_updateStats === 'function') dashboard_updateStats();
                    if (typeof dashboard_loadAndDisplayValidEmails === 'function') dashboard_loadAndDisplayValidEmails();
                    if (typeof dashboard_loadRecentActivity === 'function') dashboard_loadRecentActivity();
                    alert('Verification log and related stored valid emails cleared.'); // Keep alert for destructive
                }
            });
        }
        document.querySelectorAll('#validationLogTable th[data-sort]').forEach(headerCell => {
            headerCell.addEventListener('click', () => {
                const sortBy = headerCell.dataset.sort;
                const currentOrder = headerCell.dataset.order || 'desc'; 
                const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
                headerCell.dataset.order = newOrder;
                document.querySelectorAll('#validationLogTable th[data-sort]').forEach(th => {
                    if (th !== headerCell) delete th.dataset.order;
                });
                const selectedStatus = validationLog_statusFilter.value;
                let dataToSort = [...validationLog_fullLogData]; 
                if (selectedStatus !== 'all') {
                    dataToSort = dataToSort.filter(entry => entry.status === selectedStatus);
                }
                dataToSort.sort((a, b) => {
                    let valA = a[sortBy]; let valB = b[sortBy];
                    if (sortBy === 'timestamp') { valA = new Date(valA); valB = new Date(valB); } 
                    else if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                    if (valA < valB) return newOrder === 'asc' ? -1 : 1;
                    if (valA > valB) return newOrder === 'asc' ? 1 : -1;
                    return 0;
                });
                validationLog_renderLogTable(dataToSort);
            });
        });


        // --- Initial Setup on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            setupTheme();
            setupNavbarToggle();
            setCurrentYear();

            // Load settings first to initialize correct API
            if (typeof loadSettings === 'function') {
                loadSettings();
            }
            
            // Initialize settings and update global API variables
            if (typeof updateApiCallToUseSettings === 'function') {
                updateApiCallToUseSettings();
            }

            initEmailFinderScripts();
            initEmailVerifierScripts();
            initSettingsPageScripts();
            
            // Apply settings overrides
            updateEmailFinderToUseSettings();
            
            if (typeof dashboard_updateStats === 'function') dashboard_updateStats();
            if (typeof dashboard_loadRecentActivity === 'function') dashboard_loadRecentActivity();

            showPage('home-page-content');
        });

        // --- Settings Page JS ---
        function initSettingsPageScripts() {
            const apiSettingsForm = document.getElementById('apiSettingsForm');
            const apiUrlInput = document.getElementById('api-url');
            const apiKeyInput = document.getElementById('api-key');
            const maxParallelRequestsInput = document.getElementById('max-parallel-requests');
            const selectAllPatternsBtn = document.getElementById('select-all-patterns');
            const deselectAllPatternsBtn = document.getElementById('deselect-all-patterns');
            const resetDefaultSettingsBtn = document.getElementById('reset-default-settings');
            const testApiBtn = document.getElementById('test-api-btn');
            const testEmailInput = document.getElementById('test-email');
            const testResults = document.getElementById('test-results');
            const testResultsContent = document.getElementById('test-results-content');
            const patternCheckboxes = document.querySelectorAll('input[name="email-patterns"]');

            // Default values
            const defaultSettings = {
                apiUrl: 'https://emailverifiers-backend.bazzigate.com/single-email-varification',
                apiProvider: 'bazzigate',
                apiKey: '',
                maxParallelRequests: 50,
                emailPatterns: [
                    'first', 'last', 'firstlast', 'first.last', 'first_last', 
                    'first-last', 'flast', 'f.last', 'first.l', 'fl'
                ]
            };

            // Load settings from localStorage or use defaults
            function loadSettings() {
                const storedSettings = localStorage.getItem('leadSparkSettings');
                let settings = defaultSettings;
                
                if (storedSettings) {
                    try {
                        const parsedSettings = JSON.parse(storedSettings);
                        settings = { ...defaultSettings, ...parsedSettings };
                    } catch (e) {
                        console.error('Failed to parse stored settings:', e);
                    }
                }
                
                // Apply loaded settings to form
                apiUrlInput.value = settings.apiUrl || defaultSettings.apiUrl;
                apiKeyInput.value = settings.apiKey || '';
                maxParallelRequestsInput.value = settings.maxParallelRequests || defaultSettings.maxParallelRequests;
                
                // Apply API provider selection
                const apiProvider = settings.apiProvider || defaultSettings.apiProvider;
                document.getElementById(`api-provider-${apiProvider}`).checked = true;
                
                // Apply email pattern selections
                patternCheckboxes.forEach(checkbox => {
                    checkbox.checked = settings.emailPatterns.includes(checkbox.value);
                });

                // Update the global variables that are used by the API calls
                if (typeof VALIDATE_EMAIL_API_URL !== 'undefined') {
                    VALIDATE_EMAIL_API_URL = settings.apiUrl;
                }
                if (typeof MAX_PARALLEL_REQUESTS_PER_CHUNK !== 'undefined') {
                    MAX_PARALLEL_REQUESTS_PER_CHUNK = parseInt(settings.maxParallelRequests) || defaultSettings.maxParallelRequests;
                    console.log("Updated MAX_PARALLEL_REQUESTS_PER_CHUNK to:", MAX_PARALLEL_REQUESTS_PER_CHUNK);
                }

                return settings;
            }

            // Update max parallel requests immediately when input changes
            if (maxParallelRequestsInput) {
                ['change', 'input', 'keyup'].forEach(eventType => {
                    maxParallelRequestsInput.addEventListener(eventType, function() {
                        const newValue = parseInt(this.value) || defaultSettings.maxParallelRequests;
                        if (typeof MAX_PARALLEL_REQUESTS_PER_CHUNK !== 'undefined') {
                            MAX_PARALLEL_REQUESTS_PER_CHUNK = newValue;
                            console.log("Changed MAX_PARALLEL_REQUESTS_PER_CHUNK to:", MAX_PARALLEL_REQUESTS_PER_CHUNK);
                        }
                    });
                });
            }
            
            // Update API URL when provider changes
            function updateApiUrlForProvider() {
                const apiProviderRadios = document.querySelectorAll('input[name="api-provider"]');
                let selectedProvider = null;
                
                apiProviderRadios.forEach(radio => {
                    if (radio.checked) {
                        selectedProvider = radio.value;
                    }
                });
                
                switch (selectedProvider) {
                    case 'validate-email':
                        apiUrlInput.value = 'https://api.validate.email/validate';
                        break;
                    case 'bazzigate':
                        apiUrlInput.value = 'https://emailverifiers-backend.bazzigate.com/single-email-varification';
                        break;
                    case 'supersend':
                        apiUrlInput.value = 'https://api.supersend.io/v1/verify-email';
                        break;
                }
                
                // Update the global API URL variable immediately
                if (typeof VALIDATE_EMAIL_API_URL !== 'undefined') {
                    VALIDATE_EMAIL_API_URL = apiUrlInput.value;
                }
            }
            
            // Save current form values to localStorage
            function saveSettings() {
                const selectedPatterns = Array.from(patternCheckboxes)
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => checkbox.value);

                // Get selected API provider
                const apiProviderRadios = document.querySelectorAll('input[name="api-provider"]');
                let selectedApiProvider = defaultSettings.apiProvider;
                apiProviderRadios.forEach(radio => {
                    if (radio.checked) {
                        selectedApiProvider = radio.value;
                    }
                });

                const parallelRequests = parseInt(maxParallelRequestsInput.value) || defaultSettings.maxParallelRequests;
                
                const settings = {
                    apiUrl: apiUrlInput.value,
                    apiProvider: selectedApiProvider,
                    apiKey: apiKeyInput.value,
                    maxParallelRequests: parallelRequests,
                    emailPatterns: selectedPatterns
                };

                localStorage.setItem('leadSparkSettings', JSON.stringify(settings));
                
                // Update global variables
                if (typeof VALIDATE_EMAIL_API_URL !== 'undefined') {
                    VALIDATE_EMAIL_API_URL = settings.apiUrl;
                }
                if (typeof MAX_PARALLEL_REQUESTS_PER_CHUNK !== 'undefined') {
                    MAX_PARALLEL_REQUESTS_PER_CHUNK = parallelRequests;
                    console.log("Updated MAX_PARALLEL_REQUESTS_PER_CHUNK to:", MAX_PARALLEL_REQUESTS_PER_CHUNK);
                }

                return settings;
            }

            // Event handlers
            if (apiSettingsForm) {
                apiSettingsForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const settings = saveSettings();
                    alert('Settings saved successfully!');
                });
            }

            if (selectAllPatternsBtn) {
                selectAllPatternsBtn.addEventListener('click', () => {
                    patternCheckboxes.forEach(checkbox => checkbox.checked = true);
                });
            }

            if (deselectAllPatternsBtn) {
                deselectAllPatternsBtn.addEventListener('click', () => {
                    patternCheckboxes.forEach(checkbox => checkbox.checked = false);
                });
            }

            if (resetDefaultSettingsBtn) {
                resetDefaultSettingsBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all settings to defaults?')) {
                        localStorage.removeItem('leadSparkSettings');
                        loadSettings();
                        alert('Settings reset to defaults.');
                    }
                });
            }

            // Test API functionality
            if (testApiBtn && testEmailInput) {
                testApiBtn.addEventListener('click', async () => {
                    const email = testEmailInput.value.trim();
                    if (!email) {
                        alert('Please enter an email to test');
                        return;
                    }
                    
                    testApiBtn.textContent = 'Testing...';
                    testApiBtn.disabled = true;
                    testResults.style.display = 'none';
                    
                    // Get current settings
                    const settings = saveSettings();
                    
                    try {
                        // Construct API URL with or without API key
                        let apiUrl = `${settings.apiUrl}?email=${encodeURIComponent(email)}`;
                        
                        if (settings.apiKey) {
                            const separator = apiUrl.includes('?') ? '&' : '?';
                            apiUrl += `${separator}api_key=${encodeURIComponent(settings.apiKey)}`;
                        }
                        
                        const response = await fetch(apiUrl);
                        const data = await response.json();
                        
                        testResultsContent.textContent = JSON.stringify(data, null, 2);
                        testResults.style.display = 'block';
                    } catch (error) {
                        testResultsContent.textContent = `Error: ${error.message}`;
                        testResults.style.display = 'block';
                    } finally {
                        testApiBtn.textContent = 'Test API';
                        testApiBtn.disabled = false;
                    }
                });
            }

            // Add event listeners to API provider radio buttons
            document.querySelectorAll('input[name="api-provider"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateApiUrlForProvider();
                    // Save settings immediately when API provider changes
                    saveSettings();
                });
            });

            // Initialize
            loadSettings();
        }

        // --- Update Email Finder to use the configured patterns ---
        function updateEmailFinderToUseSettings() {
            // Get the original generateEmailPermutations function
            const originalGenerateEmailPermutations = typeof generateEmailPermutations === 'function' 
                ? generateEmailPermutations 
                : null;
                
            if (originalGenerateEmailPermutations) {
                // Override the function to use settings
                window.generateEmailPermutations = function(firstName, lastName, domain) {
                    if (!firstName || !domain) return [];
                    firstName = firstName.toLowerCase().replace(/[^a-z0-9]/g, ''); 
                    lastName = lastName ? lastName.toLowerCase().replace(/[^a-z0-9]/g, '') : '';
                    domain = domain.toLowerCase();
                    
                    // Get selected patterns from settings
                    const storedSettings = localStorage.getItem('leadSparkSettings');
                    let enabledPatterns = [];
                    
                    if (storedSettings) {
                        try {
                            const settings = JSON.parse(storedSettings);
                            enabledPatterns = settings.emailPatterns || [];
                        } catch (e) {
                            console.error('Failed to parse stored settings for email patterns:', e);
                            return originalGenerateEmailPermutations(firstName, lastName, domain);
                        }
                    } else {
                        // If no settings found, use all patterns
                        return originalGenerateEmailPermutations(firstName, lastName, domain);
                    }
                    
                    if (enabledPatterns.length === 0) {
                        return []; // No patterns selected
                    }
                    
                    const permutations = new Set();
                    const f = firstName;
                    const l = lastName;
                    const fi = f.charAt(0);
                    const li = l ? l.charAt(0) : '';
                    
                    // Only add permutations for selected patterns
                    if (enabledPatterns.includes('first')) permutations.add(`${f}@${domain}`);
                    if (l && enabledPatterns.includes('last')) permutations.add(`${l}@${domain}`);
                    if (l && enabledPatterns.includes('firstlast')) permutations.add(`${f}${l}@${domain}`);
                    if (l && enabledPatterns.includes('lastfirst')) permutations.add(`${l}${f}@${domain}`);
                    if (l && enabledPatterns.includes('first.last')) permutations.add(`${f}.${l}@${domain}`);
                    if (l && enabledPatterns.includes('last.first')) permutations.add(`${l}.${f}@${domain}`);
                    if (l && enabledPatterns.includes('first_last')) permutations.add(`${f}_${l}@${domain}`);
                    if (l && enabledPatterns.includes('last_first')) permutations.add(`${l}_${f}@${domain}`);
                    if (l && enabledPatterns.includes('first-last')) permutations.add(`${f}-${l}@${domain}`);
                    if (l && enabledPatterns.includes('last-first')) permutations.add(`${l}-${f}@${domain}`);
                    if (l && enabledPatterns.includes('flast')) permutations.add(`${fi}${l}@${domain}`);
                    if (l && enabledPatterns.includes('f.last')) permutations.add(`${fi}.${l}@${domain}`);
                    if (l && enabledPatterns.includes('first.l')) permutations.add(`${f}.${li}@${domain}`);
                    if (l && enabledPatterns.includes('fl')) permutations.add(`${fi}${li}@${domain}`);
                    
                    return Array.from(permutations);
                };
            }
        }

        // --- Update API call to include API key if present ---
        function updateApiCallToUseSettings() {
            // Get the original API call function
            const originalCallValidateEmailAPI = typeof callValidateEmailAPI === 'function' 
                ? callValidateEmailAPI 
                : null;
                
            if (originalCallValidateEmailAPI) {
                // Override the function to use settings
                window.callValidateEmailAPI = async function(email) {
                    try {
                        // Get API settings
                        const storedSettings = localStorage.getItem('leadSparkSettings');
                        let apiUrl = VALIDATE_EMAIL_API_URL;
                        let apiKey = '';
                        let apiProvider = 'bazzigate';
                        
                        if (storedSettings) {
                            try {
                                const settings = JSON.parse(storedSettings);
                                apiUrl = settings.apiUrl || apiUrl;
                                apiKey = settings.apiKey || '';
                                apiProvider = settings.apiProvider || apiProvider;
                            } catch (e) {
                                console.error('Failed to parse stored settings for API call:', e);
                            }
                        }
                        
                        // Construct API URL with or without API key
                        let fullApiUrl = `${apiUrl}?email=${encodeURIComponent(email)}`;
                        
                        // Add API key if needed, based on provider
                        if (apiKey) {
                            switch (apiProvider) {
                                case 'validate-email':
                                    fullApiUrl += `&api_key=${encodeURIComponent(apiKey)}`;
                                    break;
                                case 'supersend':
                                    fullApiUrl += `&key=${encodeURIComponent(apiKey)}`;
                                    break;
                                // Bazzigate doesn't seem to use an API key in the query string
                            }
                        }
                        
                        // Set appropriate headers based on provider
                        let headers = {};
                        switch (apiProvider) {
                            case 'validate-email':
                                headers = { 'accept': 'application/json' };
                                break;
                            case 'bazzigate':
                                headers = { 'accept': 'application/json' };
                                break;
                            case 'supersend':
                                headers = { 'accept': 'application/json' };
                                if (apiKey) {
                                    headers['Authorization'] = `Bearer ${apiKey}`;
                                }
                                break;
                        }
                        
                        const response = await fetch(fullApiUrl, { headers });
                        
                        if (!response.ok) {
                            console.error(`API error for ${email}: ${response.status} ${response.statusText}`);
                            try {
                                const errorData = await response.json();
                                console.error('API error data:', errorData);
                                return { error: true, message: errorData.message || `HTTP error ${response.status}`, apiData: null, originalEmail: email };
                            } catch (e) {
                                 return { error: true, message: `HTTP error ${response.status}`, apiData: null, originalEmail: email };
                            }
                        }
                        const data = await response.json();
                        return { error: false, apiData: data, originalEmail: email };
                    } catch (error) {
                        console.error(`Network or other error validating ${email}:`, error);
                        return { error: true, message: error.message || 'Network error', apiData: null, originalEmail: email };
                    }
                };
            }
        }

    </script>
</body>
</html>
